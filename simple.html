<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horaire JSH Montréal-Centre</title>
    <link rel="icon" type="image/x-icon" href="jsh.ico">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.5;
            background-color: #f8f9fa;
            padding: 10px;
        }
        
        .header {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 15px;
        }
        
        .mode-toggle {
            display: flex;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid #ddd;
        }
        
        .mode-toggle button {
            padding: 8px 16px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .mode-toggle button.active {
            background: #007bff;
            color: white;
        }
        
        .mode-toggle button:not(.active):hover {
            background: #dee2e6;
        }
        
        .header select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            min-width: 150px;
        }
        
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .checkbox-container input[type="checkbox"] {
            transform: scale(1.2);
        }
        
        .checkbox-container label {
            font-size: 14px;
            cursor: pointer;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-style: italic;
        }
        
        .events-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .events-table th,
        .events-table td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .events-table th {
            background: #f8f9fa;
            font-weight: 600;
            font-size: 14px;
            color: #495057;
        }
        
        .events-table tr.event-row {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .events-table tr.event-row:hover {
            background: #f8f9fa;
        }
        
        .events-table tr.event-row.expanded {
            background: #e7f3ff;
        }
        
        .events-table tr.past-event {
            text-decoration: line-through;
            opacity: 0.5;
        }
        
        .day-column {
            font-weight: 600;
            color: #007bff;
            white-space: nowrap;
            font-size: 13px;
        }
        
        .datetime-column {
            white-space: nowrap;
            font-family: monospace;
            font-size: 13px;
        }
        
        .duration-column {
            white-space: nowrap;
            color: #6c757d;
            font-size: 13px;
        }
        
        .summary-column {
            font-weight: 500;
        }
        
        .description-column {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .location-column {
            color: #6c757d;
            font-style: italic;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* Rangée de détails expansible */
        .details-row {
            display: none;
            background: #f0f8ff;
        }
        
        .details-row.show {
            display: table-row;
        }
        
        .details-cell {
            padding: 15px 20px !important;
            border-bottom: 2px solid #007bff !important;
        }
        
        .details-content {
            display: grid;
            gap: 12px;
        }
        
        .detail-section {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .detail-label {
            font-weight: 600;
            color: #007bff;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .detail-value {
            color: #333;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .detail-value.location-link {
            color: #007bff;
            cursor: pointer;
            text-decoration: underline;
        }
        
        .detail-value.location-link:hover {
            color: #0056b3;
        }
        
        .expand-indicator {
            font-size: 10px;
            margin-left: 5px;
            color: #6c757d;
        }
        
        .no-events {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-style: italic;
            background: white;
            border-radius: 8px;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }
            
            .header {
                padding: 10px;
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            
            .header select {
                min-width: auto;
                width: 100%;
            }
            
            .events-table {
                font-size: 12px;
            }
            
            .events-table th,
            .events-table td {
                padding: 8px 4px;
            }
            
            .description-column {
                max-width: 120px;
            }
            
            .location-column {
                max-width: 100px;
            }
            
            .details-cell {
                padding: 12px 10px !important;
            }
            
            /* Masquer certaines colonnes sur mobile très petit */
            @media (max-width: 480px) {
                .description-column,
                .location-column {
                    display: none;
                }
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="mode-toggle">
            <button id="groupesBtn" class="active" onclick="switchMode('groupes')">Groupes</button>
            <button id="arenasBtn" onclick="switchMode('arenas')">Arénas</button>
        </div>
        
        <select id="groupSelect" onchange="filterEvents()">
            <option value="all">Tous les groupes</option>
        </select>
        
        <div class="checkbox-container">
            <input type="checkbox" id="showPastEvents" onchange="filterEvents()">
            <label for="showPastEvents">Afficher les événements passés</label>
        </div>
    </div>
    
    <div id="eventsContainer">
        <div class="loading">Chargement des événements...</div>
    </div>

    <script>
        const repoConfig = {
            owner: 'jsh-mtl-centre',
            repo: 'horaire',
            branch: 'main'
        };
        
        let allEvents = [];
        let calendars = [];
        let currentMode = 'groupes'; // 'groupes' ou 'arenas'

        // Démarrer automatiquement au chargement de la page
        window.addEventListener('load', loadCalendars);

        function switchMode(mode) {
            currentMode = mode;
            
            // Mettre à jour les boutons
            document.getElementById('groupesBtn').classList.toggle('active', mode === 'groupes');
            document.getElementById('arenasBtn').classList.toggle('active', mode === 'arenas');
            
            // Mettre à jour le texte du select
            const select = document.getElementById('groupSelect');
            const allOption = select.querySelector('option[value="all"]');
            if (mode === 'groupes') {
                allOption.textContent = 'Tous les groupes';
            } else {
                allOption.textContent = 'Toutes les arénas';
            }
            
            // Recharger les calendriers pour le nouveau mode
            loadCalendars();
        }

        async function loadCalendars() {
            try {
                // Afficher le loading
                document.getElementById('eventsContainer').innerHTML = '<div class="loading">Chargement des événements...</div>';
                
                // Cache buster qui change toutes les 10 minutes
                const now = new Date();
                const roundedTime = Math.floor(now.getTime() / (10 * 60 * 1000)) * (10 * 60 * 1000);
                const cacheBuster = `t=${roundedTime}`;
                
                // Charger le fichier JSON généré par GitHub Actions
                const response = await fetch(`https://${repoConfig.owner}.github.io/${repoConfig.repo}/calendars.json?${cacheBuster}`);
                
                if (!response.ok) {
                    throw new Error(`Erreur lors du chargement: ${response.status}`);
                }
                
                const calendarsData = await response.json();
                
                // Traiter selon le mode sélectionné
                allEvents = [];
                calendars = [];
                
                // Choisir la source et le répertoire selon le mode
                const sourceData = currentMode === 'groupes' ? calendarsData.groupes : calendarsData.arenas;
                const icsFolder = currentMode === 'groupes' ? 'ics_groupes' : 'ics_arenas';
                
                // Ajouter les calendriers du mode sélectionné
                for (const file of sourceData) {
                    const calendar = {
                        name: file.name,
                        fileName: file.fileName,
                        url: `https://${repoConfig.owner}.github.io/${repoConfig.repo}/${icsFolder}/${file.fileName}?${cacheBuster}`,
                        events: []
                    };
                    calendars.push(calendar);
                    
                    try {
                        await loadCalendarEvents(calendar);
                        calendar.events.forEach(event => {
                            event.calendarName = calendar.name;
                        });
                        allEvents.push(...calendar.events);
                    } catch (error) {
                        console.error(`Erreur pour ${calendar.name}:`, error);
                    }
                }
                
                // Trier tous les événements par date
                allEvents.sort((a, b) => a.startDate - b.startDate);
                
                // Peupler le menu déroulant et afficher les événements
                populateGroupSelect();
                filterEvents();
                
            } catch (error) {
                console.error('Erreur:', error);
                showError(`Erreur: ${error.message}`);
            }
        }

        async function loadCalendarEvents(calendar) {
            const response = await fetch(calendar.url);
            if (!response.ok) {
                throw new Error(`Erreur lors du téléchargement: ${response.status}`);
            }
            
            const icsData = await response.text();
            calendar.events = parseIcsData(icsData);
        }

        function unescapeIcsText(text) {
            if (!text) return text;
            return text
                .replace(/\\,/g, ',')
                .replace(/\\;/g, ';')
                .replace(/\\n/g, '\n')
                .replace(/\\N/g, '\n')
                .replace(/\\\\/g, '\\');
        }

        function parseIcsData(icsData) {
            const events = [];
            const lines = icsData.split('\n');
            let currentEvent = null;
            
            for (let line of lines) {
                line = line.trim();
                
                if (line === 'BEGIN:VEVENT') {
                    currentEvent = {};
                } else if (line === 'END:VEVENT' && currentEvent) {
                    if (currentEvent.dtstart && currentEvent.dtend) {
                        currentEvent.startDate = parseIcsDate(currentEvent.dtstart);
                        currentEvent.endDate = parseIcsDate(currentEvent.dtend);
                        currentEvent.isPast = currentEvent.endDate < new Date();
                        events.push(currentEvent);
                    }
                    currentEvent = null;
                } else if (currentEvent) {
                    const [key, ...valueParts] = line.split(':');
                    const value = unescapeIcsText(valueParts.join(':'));
                    
                    switch (key.split(';')[0]) {
                        case 'DTSTART':
                            currentEvent.dtstart = valueParts.join(':'); // Ne pas unescape les dates
                            break;
                        case 'DTEND':
                            currentEvent.dtend = valueParts.join(':'); // Ne pas unescape les dates
                            break;
                        case 'SUMMARY':
                            currentEvent.summary = value;
                            break;
                        case 'DESCRIPTION':
                            currentEvent.description = value;
                            break;
                        case 'LOCATION':
                            currentEvent.location = value;
                            break;
                    }
                }
            }
            
            return events;
        }

        function parseIcsDate(dateString) {
            const cleanDate = dateString.replace(/[TZ]/g, '');
            const year = parseInt(cleanDate.substring(0, 4));
            const month = parseInt(cleanDate.substring(4, 6)) - 1;
            const day = parseInt(cleanDate.substring(6, 8));
            const hour = parseInt(cleanDate.substring(8, 10)) || 0;
            const minute = parseInt(cleanDate.substring(10, 12)) || 0;
            const second = parseInt(cleanDate.substring(12, 14)) || 0;
            
            return new Date(year, month, day, hour, minute, second);
        }

        function populateGroupSelect() {
            const select = document.getElementById('groupSelect');
            
            // Vider les options existantes sauf la première
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            calendars.forEach(calendar => {
                const option = document.createElement('option');
                option.value = calendar.name;
                option.textContent = calendar.name;
                select.appendChild(option);
            });
        }

        function filterEvents() {
            const selectedGroup = document.getElementById('groupSelect').value;
            const showPast = document.getElementById('showPastEvents').checked;
            
            let filteredEvents = allEvents;
            
            // Filtrer par groupe/aréna
            if (selectedGroup !== 'all') {
                filteredEvents = filteredEvents.filter(event => event.calendarName === selectedGroup);
            }
            
            // Filtrer les événements passés
            if (!showPast) {
                filteredEvents = filteredEvents.filter(event => !event.isPast);
            }
            
            renderEvents(filteredEvents);
        }

        function toggleEventDetails(eventIndex) {
            const detailsRow = document.getElementById(`details-${eventIndex}`);
            const eventRow = document.getElementById(`event-${eventIndex}`);
            
            if (detailsRow.classList.contains('show')) {
                detailsRow.classList.remove('show');
                eventRow.classList.remove('expanded');
            } else {
                // Fermer toutes les autres rangées ouvertes
                document.querySelectorAll('.details-row.show').forEach(row => {
                    row.classList.remove('show');
                });
                document.querySelectorAll('.event-row.expanded').forEach(row => {
                    row.classList.remove('expanded');
                });
                
                detailsRow.classList.add('show');
                eventRow.classList.add('expanded');
            }
        }

        function openGoogleMaps(event, location) {
            event.stopPropagagation();
            if (location) {
                // Remplacer les apostrophes typographiques par des apostrophes standards
                const cleanLocation = location
                    .replace(/'/g, "'")  // Apostrophe typographique → apostrophe standard
                    .replace(/'/g, "'"); // Autre variante d'apostrophe typographique
                
                const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(cleanLocation)}`;
                window.open(mapsUrl, '_blank');
            }
        }

        function renderEvents(events) {
            const container = document.getElementById('eventsContainer');
            
            if (events.length === 0) {
                container.innerHTML = '<div class="no-events">Aucun événement trouvé</div>';
                return;
            }
            
            const table = document.createElement('table');
            table.className = 'events-table';
            
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Jour</th>
                        <th>Date/Heure</th>
                        <th>Durée</th>
                        <th>Résumé</th>
                        <th class="description-column">Description</th>
                        <th class="location-column">Lieu</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;
            
            const tbody = table.querySelector('tbody');
            
            events.forEach((event, index) => {
                // Rangée principale
                const row = document.createElement('tr');
                row.className = 'event-row';
                row.id = `event-${index}`;
                if (event.isPast) {
                    row.classList.add('past-event');
                }
                row.onclick = () => toggleEventDetails(index);
                
                const dayOfWeek = getDayOfWeek(event.startDate);
                const dateTime = formatDateTime(event.startDate);
                const duration = formatDuration(event.startDate, event.endDate);
                const summary = event.summary || 'Sans titre';
                const description = event.description || '';
                const location = event.location || '';
                
                row.innerHTML = `
                    <td class="day-column">${dayOfWeek}</td>
                    <td class="datetime-column">${dateTime}</td>
                    <td class="duration-column">${duration}</td>
                    <td class="summary-column">${escapeHtml(summary)}<span class="expand-indicator">▼</span></td>
                    <td class="description-column" title="${escapeHtml(description)}">${escapeHtml(description)}</td>
                    <td class="location-column" title="${escapeHtml(location)}">${escapeHtml(location)}</td>
                `;
                
                tbody.appendChild(row);
                
                // Rangée de détails (cachée par défaut)
                const detailsRow = document.createElement('tr');
                detailsRow.className = 'details-row';
                detailsRow.id = `details-${index}`;
                
                const detailsCell = document.createElement('td');
                detailsCell.className = 'details-cell';
                detailsCell.colSpan = 6;
                
                const hasDescription = description.trim().length > 0;
                const hasLocation = location.trim().length > 0;
                
                let detailsHTML = '<div class="details-content">';
                
                if (hasDescription) {
                    detailsHTML += `
                        <div class="detail-section">
                            <div class="detail-label">Description</div>
                            <div class="detail-value">${escapeHtml(description)}</div>
                        </div>
                    `;
                }
                
                if (hasLocation) {
                    detailsHTML += `
                        <div class="detail-section">
                            <div class="detail-label">Lieu</div>
                            <div class="detail-value location-link" onclick="openGoogleMaps(event, '${escapeHtml(location).replace(/'/g, "&#39;")}')">${escapeHtml(location)}</div>
                        </div>
                    `;
                }
                
                if (!hasDescription && !hasLocation) {
                    detailsHTML += '<div class="detail-value">Aucun détail supplémentaire disponible</div>';
                }
                
                detailsHTML += '</div>';
                
                detailsCell.innerHTML = detailsHTML;
                detailsRow.appendChild(detailsCell);
                tbody.appendChild(detailsRow);
            });
            
            container.innerHTML = '';
            container.appendChild(table);
        }

        function getDayOfWeek(date) {
            const days = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
            return days[date.getDay()];
        }

        function formatDateTime(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hour = String(date.getHours()).padStart(2, '0');
            const minute = String(date.getMinutes()).padStart(2, '0');
            
            return `${year}-${month}-${day} ${hour}:${minute}`;
        }

        function formatDuration(startDate, endDate) {
            const durationMs = endDate - startDate;
            const hours = Math.floor(durationMs / (1000 * 60 * 60));
            const minutes = Math.floor((durationMs % (1000 * 60 * 60)) / (1000 * 60));
            
            if (hours > 0) {
                return `${hours}h${minutes > 0 ? ` ${minutes}m` : ''}`;
            } else {
                return `${minutes}m`;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showError(message) {
            const container = document.getElementById('eventsContainer');
            container.innerHTML = `<div class="error">${message}</div>`;
        }
    </script>
</body>
</html>